<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BADMINTON ScoreBoard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,300;0,600;0,900;1,900&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        :root {
            /* --- 核心顏色定義 --- */
            --color-red: #FF2E63;   /* 霓虹紅 */
            --color-blue: #08D9D6;  /* 霓虹藍 */

            /* 分數文字顏色 */
            --color-txt-left: var(--color-red);
            --color-txt-right: var(--color-blue);

            /* --- 球員追蹤色 --- */
            --p-left-1: var(--color-red);    
            --p-left-2: var(--color-blue);   
            --p-right-1: var(--color-blue);  
            --p-right-2: var(--color-red);   

            --font-main: 'Kanit', sans-serif;
            --score-size-normal: 13rem; 
            --score-size-huge: 40vw; 
        }

        body { 
            margin: 0; background: #000; color: #fff; 
            font-family: var(--font-main);
            overflow: hidden; width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            user-select: none; touch-action: none; 
        }

        /* --- Portrait Lock --- */
        #portrait-lock {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none; 
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        .lock-title { font-size: 3rem; font-weight: 900; font-style: italic; letter-spacing: 5px; margin-bottom: 20px; color: #fff; }
        .rotate-icon {
            width: 60px; height: 100px; border: 4px solid #fff; border-radius: 10px;
            animation: rotate-anim 2s infinite ease-in-out; margin-bottom: 20px; position: relative;
        }
        .rotate-icon::before {
            content: ''; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #fff; border-radius: 50%;
        }
        .lock-subtitle { font-size: 1.2rem; opacity: 0.6; letter-spacing: 2px; color: #aaa; }
        @keyframes rotate-anim { 0% { transform: rotate(0deg); } 40% { transform: rotate(90deg); } 100% { transform: rotate(90deg); } }
        @media screen and (orientation: portrait) {
            #portrait-lock { display: flex; }
            #game-container, #start-screen, #server-select-screen, #name-input-screen { display: none !important; }
        }

        /* --- Screens --- */
        #start-screen, #server-select-screen, #winner-screen, #name-input-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; transition: opacity 0.5s;
        }
        #server-select-screen, #winner-screen, #name-input-screen { display: none; } 

        .start-container { text-align: center; }
        .main-title {
            font-size: 4rem; font-weight: 900; font-style: italic;
            color: #fff; letter-spacing: 5px; margin: 0 0 40px 0;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        /* AI Toggle */
        .ai-toggle-container {
            margin-top: 50px; display: flex; align-items: center; justify-content: center; gap: 15px;
            opacity: 0.7; transition: opacity 0.3s;
        }
        .ai-toggle-container:hover { opacity: 1; }
        .ai-label { font-size: 1.2rem; font-weight: bold; color: #fff; letter-spacing: 1px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s; border-radius: 30px; border: 1px solid #555;
        }
        .slider:before {
            position: absolute; content: ""; height: 24px; width: 24px; left: 3px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--color-txt-right); border-color: var(--color-txt-right); }
        input:checked + .slider:before { transform: translateX(28px); }

        /* --- Unified Modals (Warning & Tutorial) --- */
        #ai-warning-modal, #tutorial-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: none; justify-content: center; align-items: center;
        }
        
        /* 統一的 Modal Box 樣式 */
        .modal-box {
            background: #1a1a1a; 
            border: 2px solid #fff; /* 統一白色邊框 */
            padding: 40px; border-radius: 20px; text-align: center;
            max-width: 550px; width: 85%;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.15); /* 統一光暈 */
        }

        .modal-title {
            font-size: 2.5rem; font-weight: 900; color: #fff;
            margin-bottom: 25px; letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .modal-text {
            font-size: 1.3rem; color: #ccc; line-height: 1.8; margin-bottom: 30px;
            font-weight: 300;
        }

        /* Warning 特化置中 */
        #ai-warning-modal .modal-text { text-align: center; }

        /* Tutorial 特化列表靠左 */
        #tutorial-list {
            text-align: left; padding-left: 0; list-style: none; margin-bottom: 30px;
            padding: 0 20px; /* 增加內距 */
        }
        #tutorial-list li { margin-bottom: 15px; }
        #tutorial-list li strong { color: #fff; font-weight: 600; }

        .modal-buttons { display: flex; justify-content: center; gap: 20px; }
        .modal-btn {
            padding: 12px 40px; border-radius: 30px; font-family: var(--font-main);
            font-weight: bold; font-size: 1.2rem; cursor: pointer; border: none;
            transition: all 0.2s;
        }
        .btn-cancel { background: #333; color: #fff; border: 1px solid #555; }
        .btn-cancel:hover { background: #444; }
        .btn-confirm { background: #fff; color: #000; }
        .btn-confirm:hover { box-shadow: 0 0 20px rgba(255,255,255,0.5); }

        .mode-btn-container { display: flex; gap: 30px; justify-content: center; width: 100%; }
        .btn-mode {
            flex: 1; font-family: var(--font-main); font-size: 2rem; font-weight: 900; font-style: italic;
            color: #fff; background: transparent; border: none; padding: 20px 0; 
            cursor: pointer; text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255,255,255,0.5); transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50px;
        }
        .btn-mode:hover { border-color: #fff; background: rgba(255,255,255,0.1); transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,0.2); }

        /* --- Name Input Screen --- */
        #name-inputs-wrapper { display: flex; gap: 50px; margin-bottom: 40px; }
        .team-input-col { display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .team-title { font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; margin-bottom: 10px; }
        
        .input-box {
            background: rgba(255, 255, 255, 0.15); 
            border: none; border-radius: 12px;
            color: #fff; font-family: var(--font-main); font-size: 1.5rem; font-weight: bold;
            width: 160px; text-align: center; padding: 12px;
            text-transform: uppercase; outline: none; transition: all 0.3s;
        }
        .input-box::placeholder { color: rgba(255,255,255,0.3); font-weight: normal; }
        .input-box:focus { background: rgba(255, 255, 255, 0.25); box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        
        .nav-btn-container { display: flex; gap: 20px; justify-content: center; width: 100%; }
        .btn-nav {
            font-family: var(--font-main); font-size: 1.2rem; font-weight: 900; font-style: italic;
            color: #fff; background: transparent; border: none; padding: 10px 40px; 
            cursor: pointer; text-transform: uppercase; transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50px;
        }
        .btn-nav:hover { background: rgba(255,255,255,0.1); border-color: #fff; }

        /* --- Server Select --- */
        .split-select { display: flex; width: 100%; height: 100%; }
        .select-zone {
            width: 50%; height: 100%; display: flex; justify-content: center; align-items: center;
            font-size: 5rem; font-weight: 900; font-style: italic; border: none; cursor: pointer; transition: background 0.3s;
        }
        .zone-left { color: var(--color-txt-left); text-shadow: 0 0 20px var(--color-txt-left), 0 0 40px var(--color-txt-left); }
        .zone-right { color: var(--color-txt-right); text-shadow: 0 0 20px var(--color-txt-right), 0 0 40px var(--color-txt-right); }
        .select-zone:active { background: rgba(255,255,255,0.1); }
        .select-hint { position: absolute; top: 20%; width: 100%; text-align: center; font-size: 2rem; pointer-events: none; text-shadow: 0 0 10px #fff; z-index: 10; }
        
        #server-back-btn { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 20; }

        /* --- Winner --- */
        #winner-text { font-size: 4rem; font-weight: 900; color: #FFE700; text-shadow: 0 0 20px #FFE700; margin-bottom: 20px; }
        #btn-restart { font-size: 2rem; border: 2px solid #fff; background: transparent; color: #fff; padding: 10px 30px; cursor: pointer; font-family: var(--font-main); }

        /* --- Game --- */
        #game-container { position: relative; width: 100%; height: 100%; transition: background 0.5s; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); display: none; }
        body.mode-blackout #game-container { background: #000; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); transition: opacity 0.5s ease; }
        body.mode-blackout video { opacity: 0; }

        /* --- Side Bars --- */
        .side-bar-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .side-bar { position: absolute; width: 10px; height: 49.5%; background: transparent; transition: all 0.3s; opacity: 0.1; }
        #bar-left-top { top: 0; left: 0; border-bottom-right-radius: 10px; }
        #bar-left-bottom { bottom: 0; left: 0; border-top-right-radius: 10px; }
        #bar-right-top { top: 0; right: 0; border-bottom-left-radius: 10px; }
        #bar-right-bottom { bottom: 0; right: 0; border-top-left-radius: 10px; }
        
        .bar-active { opacity: 1; background-color: var(--bar-color); box-shadow: 0 0 50px 15px var(--bar-color); width: 15px; }
        .bar-partner { opacity: 0.3; background-color: var(--bar-color); box-shadow: 0 0 10px 2px var(--bar-color); width: 10px; }

        /* --- Name Labels --- */
        .name-label {
            position: absolute; 
            font-size: 2.5rem; font-weight: 900; color: #fff; 
            text-shadow: none; z-index: 15; pointer-events: none;
            text-transform: uppercase;
            opacity: 0; transition: opacity 0.2s;
        }
        .name-visible { opacity: 1; }
        #name-lt { top: 25%; left: 30px; }
        #name-lb { bottom: 25%; left: 30px; }
        #name-rt { top: 25%; right: 30px; }
        #name-rb { bottom: 25%; right: 30px; }

        /* --- UI --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: center; }
        
        #bottom-controls { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            pointer-events: auto; z-index: 20; 
            display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; width: 95%;
            transition: opacity 0.5s ease; opacity: 0;
        }
        .controls-visible #bottom-controls { opacity: 1; }

        #serve-arrow-svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; opacity: 0; transition: all 0.3s; z-index: 100; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        .svg-arrow-left { fill: var(--color-txt-left); transform: translate(-50%, -50%) rotate(180deg) !important; opacity: 1 !important; filter: drop-shadow(0 0 20px var(--color-txt-left)) !important; }
        .svg-arrow-right { fill: var(--color-txt-right); transform: translate(-50%, -50%) rotate(0deg) !important; opacity: 1 !important; filter: drop-shadow(0 0 20px var(--color-txt-right)) !important; }

        .btn { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.8); padding: 8px 20px; font-family: var(--font-main); font-weight: 600; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(4px); border-radius: 4px; }
        .btn:hover { background: rgba(255,255,255,0.1); border-color: #fff; color: #fff; }
        #btn-exit:hover { border-color: #ff5555; color: #ff5555; }

        .scoreboard-row { display: flex; justify-content: space-between; align-items: center; padding: 30px 60px; width: 100%; height: 100%; box-sizing: border-box; }
        body.mode-blackout .scoreboard-row { padding: 0 20px; }
        .score-group { display: flex; flex-direction: column; align-items: center; width: 45%; height: 80%; justify-content: center; position: relative; pointer-events: auto; border: none; cursor: ns-resize; }
        .score-num { font-size: var(--score-size-normal); font-weight: 900; line-height: 0.9; font-style: italic; transition: font-size 0.5s; z-index: 1; pointer-events: none; }
        body.mode-blackout .score-num { font-size: var(--score-size-huge); line-height: 0.8; }
        
        #lbl-left { color: var(--color-txt-left); }
        #score-left { color: transparent; -webkit-text-stroke: 3px var(--color-txt-left); }
        #score-left.has-score { color: var(--color-txt-left); -webkit-text-stroke: 0; text-shadow: 0 0 30px var(--color-txt-left), 0 0 60px var(--color-txt-left); }
        #lbl-right { color: var(--color-txt-right); }
        #score-right { color: transparent; -webkit-text-stroke: 3px var(--color-txt-right); }
        #score-right.has-score { color: var(--color-txt-right); -webkit-text-stroke: 0; text-shadow: 0 0 30px var(--color-txt-right), 0 0 60px var(--color-txt-right); }
        .score-pop { animation: bump 0.2s ease-out; }
        @keyframes bump { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        #loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #fff; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        #loading-text { font-weight: 300; letter-spacing: 1px; font-size: 14px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="portrait-lock">
        <div class="lock-title">BADMINTON</div>
        <div class="rotate-icon"></div>
        <div class="lock-subtitle">PLEASE ROTATE DEVICE <br>螢幕轉橫/連點切換全螢幕</div>
    </div>

    <div id="ai-warning-modal">
        <div class="modal-box">
            <div class="modal-title">WARNING</div>
            <div class="modal-text">
                AI輔助辨識系統尚未完善，<br>
                可能發生系統閃退卡頓等情形
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="cancelAI()">CANCEL</button>
                <button class="modal-btn btn-confirm" onclick="confirmAI()">CONFIRM</button>
            </div>
        </div>
    </div>

    <div id="tutorial-modal">
        <div class="modal-box">
            <div class="modal-title" id="tutorial-title">MODE TUTORIAL</div>
            <ul class="modal-text" id="tutorial-list">
                </ul>
            <div class="modal-buttons">
                <button class="modal-btn btn-confirm" onclick="closeTutorial()">GOT IT</button>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <div class="start-container">
            <h1 class="main-title">BADMINTON</h1>
            <div class="mode-btn-container">
                <button class="btn-mode" onclick="selectMode('singles')">SINGLES</button>
                <button class="btn-mode" onclick="selectMode('doubles')">DOUBLES</button>
            </div>
            <div class="ai-toggle-container">
                <span class="ai-label">AI ASSIST</span>
                <label class="switch">
                    <input type="checkbox" id="ai-toggle-checkbox">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="lock-subtitle"> <br>連點切換全螢幕<br>Double-click to enter fullscreen</div>
        </div>
    </div>

    <div id="name-input-screen">
        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 30px; letter-spacing: 2px;">ENTER NAMES</div>
        <div id="name-inputs-wrapper"></div>
        <div class="nav-btn-container">
            <button class="btn-nav" onclick="goBackToStart()">BACK</button>
            <button class="btn-nav" onclick="submitNames()">NEXT</button>
        </div>
    </div>

    <div id="server-select-screen">
        <div class="select-hint">WHO SERVES FIRST?</div>
        <div class="split-select">
            <div class="select-zone zone-left" onclick="initSystem('left')">LEFT</div>
            <div class="select-zone zone-right" onclick="initSystem('right')">RIGHT</div>
        </div>
        <button id="server-back-btn" class="btn-nav" onclick="goBackToNameInput()">BACK</button>
    </div>

    <div id="winner-screen">
        <div id="winner-text">PLAYER WINS!</div>
        <button id="btn-restart" onclick="exitGame()">PLAY AGAIN</button>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <div id="loading-text">INITIALIZING...</div>
    </div>

    <div id="game-container">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="output"></canvas>

        <div class="side-bar-container">
            <div id="bar-left-top" class="side-bar"></div>
            <div id="bar-left-bottom" class="side-bar"></div>
            <div id="bar-right-top" class="side-bar"></div>
            <div id="bar-right-bottom" class="side-bar"></div>
        </div>

        <div id="name-labels-layer">
            <div id="name-lt" class="name-label"></div>
            <div id="name-lb" class="name-label"></div>
            <div id="name-rt" class="name-label"></div>
            <div id="name-rb" class="name-label"></div>
        </div>

        <div id="ui-layer">
            <svg id="serve-arrow-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path d="M 20,20 L 80,50 L 20,80 Z" stroke-linejoin="round" stroke-width="10" />
            </svg>
            
            <div class="scoreboard-row">
                <div class="score-group" id="group-left">
                    <div id="score-left" class="score-num">0</div>
                </div>
                <div class="score-group" id="group-right">
                    <div id="score-right" class="score-num">0</div>
                </div>
            </div>

            <div id="bottom-controls">
                <button class="btn" onclick="resetScores()">RESET</button>
                <button class="btn" id="btn-names" onclick="toggleNames()">HIDE NAMES</button>
                <button class="btn" id="btn-cam" onclick="toggleCamera()">HIDE CAMERA</button>
                <button class="btn" onclick="changeServerSide()">CHANGE SERVE</button>
                <button class="btn" id="btn-exit" onclick="exitGame()">EXIT</button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('loading-text');
        
        const startScreen = document.getElementById('start-screen');
        const nameInputScreen = document.getElementById('name-input-screen');
        const selectScreen = document.getElementById('server-select-screen');
        const winnerScreen = document.getElementById('winner-screen');
        const gameContainer = document.getElementById('game-container');
        const uiLayer = document.getElementById('ui-layer');
        
        const btnCam = document.getElementById('btn-cam');
        const btnNames = document.getElementById('btn-names');
        const arrowSvg = document.getElementById('serve-arrow-svg');
        const bodyEl = document.body;
        const winnerText = document.getElementById('winner-text');
        const aiCheckbox = document.getElementById('ai-toggle-checkbox');
        
        const warningModal = document.getElementById('ai-warning-modal');
        const tutorialModal = document.getElementById('tutorial-modal');
        const tutorialTitle = document.getElementById('tutorial-title');
        const tutorialList = document.getElementById('tutorial-list');

        const bars = {
            lt: document.getElementById('bar-left-top'),
            lb: document.getElementById('bar-left-bottom'),
            rt: document.getElementById('bar-right-top'),
            rb: document.getElementById('bar-right-bottom')
        };

        const nameLabels = {
            lt: document.getElementById('name-lt'),
            lb: document.getElementById('name-lb'),
            rt: document.getElementById('name-rt'),
            rb: document.getElementById('name-rb')
        };

        let detector;
        let rafId;
        const WIN_SCORE = 21; const MAX_SCORE = 30;
        let scores = { left: 0, right: 0 };
        let holdStart = 0; let isHolding = false;
        const HOLD_DURATION = 1500; 
        const COOLDOWN_DURATION = 3; 
        let cooldownTimer = 0; let cooldownInterval = null;
        let isCamVisible = true; let isModelLoaded = false; 
        let isGameActive = false; let currentServer = null; 
        let gameMode = 'singles'; let isAIMode = false; 
        let leftPositions = [1, 2]; let rightPositions = [1, 2];
        let areNamesVisible = true; 
        let controlsTimer = null; 
        let tempSelectedMode = '';

        const audioLeft = new Audio('red.mp3'); const audioRight = new Audio('blue.mp3');
        let playerNames = { l1: "", l2: "", r1: "", r2: "" };

        // --- Warning Logic ---
        aiCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                warningModal.style.display = 'flex';
            } else {
                isAIMode = false;
            }
        });

        function confirmAI() {
            warningModal.style.display = 'none';
            isAIMode = true;
        }

        function cancelAI() {
            warningModal.style.display = 'none';
            aiCheckbox.checked = false;
            isAIMode = false;
        }

        // --- 1. 流程 ---

        function selectMode(mode) {
            tempSelectedMode = mode;
            
            // 設定教學內容
            if (isAIMode) {
                tutorialTitle.innerText = "AI 輔助模式";
                tutorialList.innerHTML = `
                    <li>1. 請站在鏡頭前，確保上半身可見。</li>
                    <li>2. <strong>舉起手2秒</strong>（手腕高於耳朵）感應得分。</li>
                    <li>3. 畫面左邊舉手 = 左隊得分，右邊舉手 = 右隊得分。</li>`;
            } else {
                tutorialTitle.innerText = "手動模式";
                tutorialList.innerHTML = `
                    <li>1. 在左/右側分數區域操作。</li>
                    <li>2. <strong>向上滑動</strong>：增加分數 (+1)。</li>
                    <li>3. <strong>向下滑動</strong>：減少分數 (-1)。</li>`;
            }

            startScreen.style.display = 'none';
            tutorialModal.style.display = 'flex';
        }

        function closeTutorial() {
            tutorialModal.style.display = 'none';
            goToNameInput(tempSelectedMode);
        }

        function goToNameInput(mode) {
            gameMode = mode;
            nameInputScreen.style.display = 'flex';
            generateNameInputs();
        }

        function goBackToStart() {
            nameInputScreen.style.display = 'none';
            startScreen.style.display = 'flex';
        }

        function goBackToNameInput() {
            selectScreen.style.display = 'none';
            nameInputScreen.style.display = 'flex';
        }

        function generateNameInputs() {
            const wrapper = document.getElementById('name-inputs-wrapper');
            wrapper.innerHTML = '';

            const leftCol = document.createElement('div');
            leftCol.className = 'team-input-col';
            leftCol.innerHTML = `<div class="team-title" style="color:var(--color-txt-left)">LEFT TEAM</div>`;
            const l1Input = createInput('L1', 'Player 1');
            leftCol.appendChild(l1Input);
            if (gameMode === 'doubles') {
                const l2Input = createInput('L2', 'Player 3');
                leftCol.appendChild(l2Input);
            }
            wrapper.appendChild(leftCol);

            const rightCol = document.createElement('div');
            rightCol.className = 'team-input-col';
            rightCol.innerHTML = `<div class="team-title" style="color:var(--color-txt-right)">RIGHT TEAM</div>`;
            const r1Input = createInput('R1', 'Player 2');
            rightCol.appendChild(r1Input);
            if (gameMode === 'doubles') {
                const r2Input = createInput('R2', 'Player 4');
                rightCol.appendChild(r2Input);
            }
            wrapper.appendChild(rightCol);
        }

        function createInput(idSuffix, placeholder) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-box';
            input.id = 'input-' + idSuffix;
            input.placeholder = placeholder;
            input.oninput = function() { validateNameInput(this); };
            return input;
        }

        function validateNameInput(el) {
            let str = el.value;
            // 3 Fullwidth (Weight 6)
            let weight = 0;
            let validStr = "";
            for (let i = 0; i < str.length; i++) {
                const charWeight = (str.charCodeAt(i) > 255) ? 2 : 1;
                if (weight + charWeight <= 6) {
                    weight += charWeight;
                    validStr += str[i];
                } else break;
            }
            if (str !== validStr) el.value = validStr;
        }

        function submitNames() {
            const l1 = document.getElementById('input-L1').value || "P1";
            const r1 = document.getElementById('input-R1').value || "P3";
            playerNames.l1 = l1; playerNames.r1 = r1;

            if (gameMode === 'doubles') {
                playerNames.l2 = document.getElementById('input-L2').value || "P2";
                playerNames.r2 = document.getElementById('input-R2').value || "P4";
            } else {
                playerNames.l2 = l1; playerNames.r2 = r1;
            }
            nameInputScreen.style.display = 'none';
            selectScreen.style.display = 'block';
        }

        function initSystem(firstServer) {
            selectScreen.style.display = 'none';
            currentServer = firstServer;
            scores = { left: 0, right: 0 };
            leftPositions = [1, 2]; rightPositions = [1, 2];
            areNamesVisible = true;
            btnNames.innerText = "HIDE NAMES";

            if (isAIMode) {
                isCamVisible = true;
                bodyEl.classList.remove('mode-blackout');
                btnCam.style.display = 'block';
                btnCam.innerText = "HIDE CAMERA";
            } else {
                isCamVisible = false;
                bodyEl.classList.add('mode-blackout');
                btnCam.style.display = 'none';
            }

            updateScoreUI('left'); updateScoreUI('right');
            updatePositionsUI(); 

            if (isAIMode) {
                loader.style.display = 'flex';
                startApp(); 
            } else { 
                startGameLoop(); 
            }
        }

        function resetScores() {
            scores = { left: 0, right: 0 };
            leftPositions = [1, 2]; rightPositions = [1, 2];
            cooldownTimer = 0;
            if (cooldownInterval) clearInterval(cooldownInterval);
            gameContainer.classList.remove('grayscale-mode');
            updateScoreUI('left'); updateScoreUI('right');
            updatePositionsUI();
        }
        
        function changeServerSide() {
            currentServer = (currentServer === 'left') ? 'right' : 'left';
            updatePositionsUI();
        }

        function toggleNames() {
            areNamesVisible = !areNamesVisible;
            btnNames.innerText = areNamesVisible ? "HIDE NAMES" : "SHOW NAMES";
            updatePositionsUI(); 
        }

        function exitGame() {
            isGameActive = false; 
            if(rafId) cancelAnimationFrame(rafId);

            // Stop Camera
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }

            gameContainer.style.display = 'none';
            winnerScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            scores = { left: 0, right: 0 };
            cooldownTimer = 0;
            if (cooldownInterval) clearInterval(cooldownInterval);
            gameContainer.classList.remove('grayscale-mode');
        }

        async function startApp() {
            try {
                statusText.innerText = "LOADING AI CORE...";
                await tf.setBackend('webgl'); await tf.ready();
                const stream = await navigator.mediaDevices.getUserMedia({
                    'audio': false, 'video': { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.width = video.videoWidth; video.height = video.videoHeight;
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    video.play(); 
                    if(isModelLoaded) { loader.style.display='none'; startGameLoop(); }
                    else loadModel();
                };
            } catch (e) { alert("Camera Error"); exitGame(); }
        }
        async function loadModel() {
            statusText.innerText = "CALIBRATING...";
            try {
                const model = poseDetection.SupportedModels.MoveNet;
                const detectorConfig = { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING };
                detector = await poseDetection.createDetector(model, detectorConfig);
                isModelLoaded = true; loader.style.display = 'none'; startGameLoop();
            } catch (e) { alert("Model Error"); }
        }
        function startGameLoop() {
            gameContainer.style.display = 'block';
            isGameActive = true;
            detectLoop();
            showControls();
        }

        // --- Auto Hide Controls ---
        function showControls() {
            uiLayer.classList.add('controls-visible');
            clearTimeout(controlsTimer);
            controlsTimer = setTimeout(() => {
                uiLayer.classList.remove('controls-visible');
            }, 3000);
        }
        
        ['mousemove', 'touchstart', 'click'].forEach(evt => {
            gameContainer.addEventListener(evt, showControls, {passive: true});
        });


        // --- 2. 邏輯 ---
        function manualAdjustScore(side, delta) {
            if (delta > 0) handleScorePoint(side);
            else {
                scores[side] += delta;
                if (scores[side] < 0) scores[side] = 0;
                
                if (delta < 0 && gameMode === 'doubles' && side === currentServer) {
                     if (side === 'left') {
                         let temp = leftPositions[0]; leftPositions[0] = leftPositions[1]; leftPositions[1] = temp;
                     } else {
                         let temp = rightPositions[0]; rightPositions[0] = rightPositions[1]; rightPositions[1] = temp;
                     }
                }
                updateScoreUI(side); updatePositionsUI();
            }
        }
        function scorePoint(side) {
            handleScorePoint(side);
            if (side === 'left') { audioLeft.currentTime = 0; audioLeft.play().catch(()=>{}); } 
            else { audioRight.currentTime = 0; audioRight.play().catch(()=>{}); }
            const color = side === 'left' ? 'rgba(255, 46, 99, 0.4)' : 'rgba(8, 217, 214, 0.4)';
            ctx.fillStyle = color; ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (checkWinner(side)) return;
            startCooldown(COOLDOWN_DURATION);
        }
        function handleScorePoint(winningSide) {
            if (gameMode === 'doubles') {
                if (winningSide === currentServer) {
                    if (winningSide === 'left') {
                        let temp = leftPositions[0]; leftPositions[0] = leftPositions[1]; leftPositions[1] = temp;
                    } else {
                        let temp = rightPositions[0]; rightPositions[0] = rightPositions[1]; rightPositions[1] = temp;
                    }
                }
            }
            scores[winningSide]++;
            currentServer = winningSide;
            updateScoreUI(winningSide);
            updatePositionsUI();
        }

        // --- 3. UI 更新 ---
        function updatePositionsUI() {
            Object.values(bars).forEach(bar => { bar.className = 'side-bar'; bar.style.removeProperty('--bar-color'); });
            Object.values(nameLabels).forEach(lbl => { lbl.innerText = ""; lbl.classList.remove('name-visible'); });

            const score = scores[currentServer];
            const isEven = (score % 2 === 0);
            updateArrow();

            const cLeft1 = '--p-left-1'; const cLeft2 = '--p-left-2';
            const cRight1 = '--p-right-1'; const cRight2 = '--p-right-2';
            const useMainColor = (gameMode === 'singles');

            const cLT = useMainColor ? cLeft1 : (leftPositions[1] === 1 ? cLeft1 : cLeft2); 
            const cLB = useMainColor ? cLeft1 : (leftPositions[0] === 1 ? cLeft1 : cLeft2); 
            bars.lt.style.setProperty('--bar-color', `var(${cLT})`);
            bars.lb.style.setProperty('--bar-color', `var(${cLB})`);

            const cRT = useMainColor ? cRight1 : (rightPositions[0] === 1 ? cRight1 : cRight2); 
            const cRB = useMainColor ? cRight1 : (rightPositions[1] === 1 ? cRight1 : cRight2); 
            bars.rt.style.setProperty('--bar-color', `var(${cRT})`);
            bars.rb.style.setProperty('--bar-color', `var(${cRB})`);

            // Name Display Logic
            let nameLT = "", nameLB = "", nameRT = "", nameRB = "";
            if (gameMode === 'singles') {
                if (isEven) nameLB = playerNames.l1; else nameLT = playerNames.l1;
                if (isEven) nameRT = playerNames.r1; else nameRB = playerNames.r1;
            } else {
                nameLT = leftPositions[1] === 1 ? playerNames.l1 : playerNames.l2;
                nameLB = leftPositions[0] === 1 ? playerNames.l1 : playerNames.l2;
                nameRT = rightPositions[0] === 1 ? playerNames.r1 : playerNames.r2;
                nameRB = rightPositions[1] === 1 ? playerNames.r1 : playerNames.r2;
            }

            if (areNamesVisible) {
                if(nameLT) { nameLabels.lt.innerText = nameLT; nameLabels.lt.classList.add('name-visible'); }
                if(nameLB) { nameLabels.lb.innerText = nameLB; nameLabels.lb.classList.add('name-visible'); }
                if(nameRT) { nameLabels.rt.innerText = nameRT; nameLabels.rt.classList.add('name-visible'); }
                if(nameRB) { nameLabels.rb.innerText = nameRB; nameLabels.rb.classList.add('name-visible'); }
            }

            if (isEven) {
                bars.lb.classList.add('bar-active');
                bars.rt.classList.add('bar-active');
                if (gameMode === 'doubles') { bars.lt.classList.add('bar-partner'); bars.rb.classList.add('bar-partner'); }
            } else {
                bars.lt.classList.add('bar-active');
                bars.rb.classList.add('bar-active');
                if (gameMode === 'doubles') { bars.lb.classList.add('bar-partner'); bars.rt.classList.add('bar-partner'); }
            }
        }

        function updateArrow() {
            arrowSvg.setAttribute('class', '');
            if (currentServer === 'left') arrowSvg.setAttribute('class', 'svg-arrow-left');
            else arrowSvg.setAttribute('class', 'svg-arrow-right');
        }

        // --- 輔助 ---
        function checkWinner(side) {
            const my = scores[side]; const op = scores[side==='left'?'right':'left'];
            let isWin = false;
            if (my >= WIN_SCORE) { if (my - op >= 2) isWin = true; }
            if (my === MAX_SCORE) isWin = true;
            if (isWin) { showWinner(side); return true; }
            return false;
        }
        function showWinner(side) {
            isGameActive = false; if(rafId) cancelAnimationFrame(rafId);
            const wName = side==='left' ? playerNames.l1 : playerNames.r1; 
            winnerText.innerText = wName + " WINS!";
            winnerText.style.color = side==='left'?'var(--color-txt-left)':'var(--color-txt-right)';
            setTimeout(()=>{gameContainer.style.display='none';winnerScreen.style.display='flex';},1000);
        }
        function updateScoreUI(side) {
            const el = document.getElementById(`score-${side}`); el.innerText = scores[side];
            if(scores[side]>0) el.classList.add('has-score'); else el.classList.remove('has-score');
            el.classList.remove('score-pop'); void el.offsetWidth; el.classList.add('score-pop');
        }
        function toggleCamera() {
            if (!isAIMode) return;
            isCamVisible = !isCamVisible;
            if (isCamVisible) { bodyEl.classList.remove('mode-blackout'); btnCam.innerText = "HIDE CAMERA"; }
            else { bodyEl.classList.add('mode-blackout'); btnCam.innerText = "SHOW CAMERA"; }
        }
        function startCooldown(t) {
            cooldownTimer = t || COOLDOWN_DURATION;
            // 加入灰階
            gameContainer.classList.add('grayscale-mode');
            if(cooldownInterval) clearInterval(cooldownInterval);
            const start = Date.now(); const total = cooldownTimer*1000;
            cooldownInterval = setInterval(()=>{
                const left = total - (Date.now()-start); cooldownTimer = left/1000;
                if(cooldownTimer<=0) { 
                    clearInterval(cooldownInterval); 
                    cooldownTimer=0; 
                    // 移除灰階
                    gameContainer.classList.remove('grayscale-mode');
                }
            },50);
        }
        function setupSwipeControl(id, side) {
            const el = document.getElementById(id); let sY=0;
            el.addEventListener('touchstart',e=>{sY=e.touches[0].clientY},{passive:true});
            el.addEventListener('touchend',e=>{
                if(Math.abs(sY - e.changedTouches[0].clientY)>50) manualAdjustScore(side, sY > e.changedTouches[0].clientY ? 1 : -1);
            },{passive:true});
            el.addEventListener('mousedown',e=>{sY=e.clientY});
            el.addEventListener('mouseup',e=>{
                if(Math.abs(sY - e.clientY)>50) manualAdjustScore(side, sY > e.clientY ? 1 : -1);
            });
        }
        setupSwipeControl('group-left','left'); setupSwipeControl('group-right','right');

        async function detectLoop() {
            if(!isGameActive) return;
            if(isAIMode && video.readyState>=2) {
                try {
                    const poses = await detector.estimatePoses(video);
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    if(cooldownTimer<=0) {
                        if(gameContainer.classList.contains('grayscale-mode')) gameContainer.classList.remove('grayscale-mode');
                        // drawCenterLine removed for cleanliness
                        if(poses.length>0 && poses[0].score>0.3) {
                            // if(isCamVisible) drawKeypoints(poses[0].keypoints);
                            checkGameLogic(poses[0].keypoints);
                        } else resetHold();
                    }
                } catch(e){ console.error(e); cancelAnimationFrame(rafId); return; }
            } else { ctx.clearRect(0,0,canvas.width,canvas.height); }
            rafId = requestAnimationFrame(detectLoop);
        }
        function checkGameLogic(kp) {
            const midX = canvas.width/2;
            const lw = kp.find(k=>k.name==='left_wrist'); const rw = kp.find(k=>k.name==='right_wrist');
            let active = null;
            if(lw && lw.score>0.3 && lw.y < kp.find(k=>k.name==='left_ear').y) active=lw;
            else if(rw && rw.score>0.3 && rw.y < kp.find(k=>k.name==='right_ear').y) active=rw;
            if(!active) { resetHold(); return; }
            const side = active.x > midX ? 'left' : 'right';
            if(!isHolding) { isHolding=true; holdStart=Date.now(); }
            else {
                const prog = Math.min((Date.now()-holdStart)/HOLD_DURATION, 1);
                // drawHoldRing(active.x, active.y, prog, side);
                if(prog>=1) { scorePoint(side); resetHold(); }
            }
        }
        function resetHold(){ isHolding=false; holdStart=0; }

        document.addEventListener('dblclick',e=>{
            if(e.target.tagName!=='BUTTON' && e.target.tagName!=='INPUT' && !e.target.closest('.select-zone') && !e.target.closest('.switch')) {
                if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen();
            }
        });
    </script>
</body>
</html>
